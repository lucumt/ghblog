<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>KubeSphere在当前公司提升研发效率的使用实践分享 - 飞狐的部落格</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rosen Lu" /><meta name="description" content="KubeSphere在当前公司提升研发效率的使用实践分享" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.126.1 with theme even" />


<link rel="canonical" href="https://lucumt.info/post/devops/share-kubepshere-using-experience-for-current-company/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.2d85dc0f018cb0224c2d088d09fe31bf17c3793affb37f7303834db3877e15c6.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet"><meta property="og:url" content="https://lucumt.info/post/devops/share-kubepshere-using-experience-for-current-company/">
  <meta property="og:site_name" content="飞狐的部落格">
  <meta property="og:title" content="KubeSphere在当前公司提升研发效率的使用实践分享">
  <meta property="og:description" content="KubeSphere在当前公司提升研发效率的使用实践分享">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-04-17T14:31:45+08:00">
    <meta property="article:modified_time" content="2023-04-17T14:31:45+08:00">
    <meta property="article:tag" content="Kubesphere">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Jenkins">
    <meta property="article:tag" content="Nacos">
    <meta property="article:tag" content="Shell">

  <meta itemprop="name" content="KubeSphere在当前公司提升研发效率的使用实践分享">
  <meta itemprop="description" content="KubeSphere在当前公司提升研发效率的使用实践分享">
  <meta itemprop="datePublished" content="2023-04-17T14:31:45+08:00">
  <meta itemprop="dateModified" content="2023-04-17T14:31:45+08:00">
  <meta itemprop="wordCount" content="4186">
  <meta itemprop="keywords" content="Kubesphere,Kubernetes,Docker,Jenkins,Nacos,Shell">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="KubeSphere在当前公司提升研发效率的使用实践分享">
  <meta name="twitter:description" content="KubeSphere在当前公司提升研发效率的使用实践分享">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-solarizedlight.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-highlight/prism-line-highlight.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css"/>
</head>
<body>
	  
	  <a href="https://github.com/lucumt/ghblog" title="https://github.com/lucumt/ghblog" target="_blank">  
	  <img style="position: fixed; top: 0; right: 0; border: 0; z-index:9999;" 
		 src="/blog_img/forkme_right_gray.png" 
		 alt="Fork me on GitHub">
	  </a><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Rosen&#39;s World</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a><a href="https://tech.lucumt.info">
        <li class="mobile-menu-item">外链</li>
      </a><a href="/search/">
        <li class="mobile-menu-item">搜索</li>
      </a>
  </ul>

  


</nav>
<div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper">
  <a href="/" class="logo">Rosen&#39;s World</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://tech.lucumt.info">外链</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/search/">搜索</a>
      </li>
  </ul>
</nav>

    </header><main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">KubeSphere在当前公司提升研发效率的使用实践分享</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-04-17 </span>
        <div class="post-category">
            <a href="/categories/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"> 持续集成 </a>
            </div>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#选型说明">选型说明</a></li>
        <li><a href="#实践过程">实践过程</a>
          <ul>
            <li><a href="#持续集成">持续集成</a>
              <ul>
                <li><a href="#初始实现">初始实现</a></li>
                <li><a href="#环境扩容">环境扩容</a></li>
                <li><a href="#扩展功能">扩展功能</a></li>
              </ul>
            </li>
            <li><a href="#外部部署">外部部署</a></li>
            <li><a href="#使用协助">使用协助</a></li>
          </ul>
        </li>
        <li><a href="#使用效果">使用效果</a></li>
        <li><a href="#规划">规划</a></li>
        <li><a href="#参考文章">参考文章</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
	 
	  	
	
    <div class="post-content image-border">
	 <p>我司从2022年6月开始使用<code>KubeSphere</code>到目前为止快一年时间，简要记录下此过程中的经验积累和问题反馈。</p>
<h2 id="背景">背景</h2>
<p>公司当前有接近3000人的规模，主要业务为汽车配套相关的软硬件开发，其中专门从事软件开发约有800人，这其中<code>Java</code>开发的约占70%，余下的为<code>C/C++</code>嵌入式和<code>C#</code>桌面程序的开发。</p>
<p>在<code>Java</code>开发部分约80%的都是<code>Java EE</code>开发，由于公司的业务主要是给外部客户提供软硬件产品和咨询服务，在早期公司和部门更关注的是如何将产品销售给更多的客户、获得更多的订单和尽快回款，对软件开发流程这块没有过多的重视，故早期在软件开发部分不是特别规范化。软件开发基于项目主要采用<a href="https://zh.wikipedia.org/zh-hans/%E6%95%8F%E6%8D%B7%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91">敏捷开发</a>或<a href="https://zh.wikipedia.org/wiki/%E7%80%91%E5%B8%83%E6%A8%A1%E5%9E%8B">瀑布模型</a>，而对于软件部署和运维依旧采用的纯手工方式(PS:请不要鄙视我司!)</p>
<p>随着公司规模的扩大与软件产品线的增多，上述方式逐渐暴露出一些问题：</p>
<ul>
<li>存在大量重复性工作，在软件快速迭代时，需要频繁的手工编译部署，耗费时间，且此过程缺乏日志记录，后续无法追踪审计</li>
<li>缺乏审核功能，对于测试环境和生产环境的操作需要审批流程，之前通过邮件和企业微信无法串联</li>
<li>缺乏准入功能，随着团队规模扩大，人员素质参差不齐，需要对软件开发流程、代码风格都需要强制固化</li>
<li>缺乏监控功能，后续不同团队、项目采用的监控方案不统一，不利于知识的积累</li>
<li>不同客户的定制化功能太多(logo,字体，ip地址，业务逻辑等)，采用手工打包的方式效率低，容易遗漏出错</li>
</ul>
<p>在竞争日益激烈的市场环境下，<strong>公司需要把有限的人力资源优先用于业务迭代开发</strong>，解决上述问题变得愈发迫切。</p>
<h2 id="选型说明">选型说明</h2>
<p>基于前述原因，部门准备选用网络上开源的系统来尽可能的解决上述痛点，在技术选型时有如下考量点：</p>
<ul>
<li>采用尽量少的系统，最好一套系统能解决前述所有问题，避免多个系统维护和整合的成本</li>
<li>采用开源版本，避免公司内部手工开发，节约人力</li>
<li>安装过程简洁，不需要复杂的操作，能支持离线安装</li>
<li>文档丰富、社区活跃、使用人员较多，遇到问题能较容易的找到答案</li>
<li>支持容器化部署，公司和部门的业务中自动驾驶和云仿真相关的越来越多，此部分对算力和资源提出了更高的要求</li>
</ul>
<p>最开始采用的是<a href="https://www.jenkins.io/">Jenkins</a>，通过<code>Jenkins</code>基本上能解决我们90%的问题，但依旧有如下问题影使用体验:</p>
<ul>
<li>对于云原生支持不太好，不利于部门后续云仿真相关的业务使用</li>
<li>UI界面简陋，交互方式不友好(项目构建日志输出等)</li>
<li>对于项目，资源的权限分配与隔离过于简陋，不满足多项目多部门使用时细粒度的区分要求</li>
</ul>
<p>在网络上查找后发现类似的工具有很多，经过初步对比筛选后倾向于<code>KubeSphere</code>，<a href="https://koderover.com/">Zadig</a>这2款产品，它们的基本功能都类似，进一步对比如下：</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">KubeSphere</th>
<th style="text-align:center">Zadig</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>云原生支持</strong></td>
<td style="text-align:center"><strong>高</strong></td>
<td style="text-align:center">一般</td>
</tr>
<tr>
<td><strong>UI美观度</strong></td>
<td style="text-align:center"><strong>高</strong></td>
<td style="text-align:center">一般</td>
</tr>
<tr>
<td><strong>GitHub Star</strong></td>
<td style="text-align:center"><strong>12.4k</strong></td>
<td style="text-align:center">2k</td>
</tr>
<tr>
<td><strong>社区活跃度</strong></td>
<td style="text-align:center"><strong>高</strong></td>
<td style="text-align:center">一般</td>
</tr>
<tr>
<td><strong>知名使用客户</strong></td>
<td style="text-align:center">去哪儿网、农行、移动</td>
<td style="text-align:center">飞书、腾讯、华为</td>
</tr>
</tbody>
</table>
<p><code>KubeSphere</code>在多个指标上优于<code>Zadig</code>，尤其是<code>KubeSphere</code>的UI界面十分美观比<code>Zadig</code>强很多，故最终选定<code>KubeSphere</code>作为部门内部的持续集成与容器化管理系统！</p>
<p>至此，部门内部经历了<code>手工操作</code>-&gt;<code>Jenkins</code>-&gt;<code>KubeSphere</code>这3个阶段，各阶段的主要使用点如下：</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/different-type-of-deploy-compare.png" alt="不同类型的构建方式比较" title="不同类型的构建方式比较"></p>
<h2 id="实践过程">实践过程</h2>
<p><code>KubeSphere</code>在公司内部的整体部署架构如下图所示，其作为最顶层的应用程序直接与使用人员交互，提供主动 /定时触发构建、应用监控等功能，使用人员不必关心底层的<code>Jenkins</code>、<code>Kubernetes</code>等依赖组件，只需要与<code>Gitlab</code>和<code>KubeSphere</code>交互即可。</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/kubesphere-integration-architecture.png" alt="kubesphere整合架构图" title="kubesphere整合架构图"></p>
<h3 id="持续集成">持续集成</h3>
<h4 id="初始实现">初始实现</h4>
<p>在最初的尝试阶段只规划了4套环境:<code>dev</code>(开发环境)、<code>sit</code>(调试环境)、<code>test</code>(测试环境)、<code>prod</code>(生产环境)。</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/using-jekins-to-deploy-automatic.png" alt="利用Jenkins进行自动部署" title="利用Jenkins进行自动部署"></p>
<p>出于简化使用与维护的考虑，计划对每个工程模块只维护一条流水线，通过构建时选择不同的环境参数来实现定制化打包与部署。</p>
<p><code>KubeSphere</code>和<code>Kubernetes</code>目前在部门是以单机版形式安装的，故对于不同环境的区分主要是通过分配不同端口来实现，具体实现时需要能在<code>Jenkins</code>和<code>Kubernetes</code>的<code>yaml</code>文件中都能动态的获取对应的端口参数和项目名称，参考实现代码如下：</p>
<ul>
<li>
<p>在基于<code>Groovy</code>的<code>script</code>中根据选择环境动态分配相关端口</p>
<pre class="line-numbers language-groovy " title="groovy">
<code>switch(PRODUCT_PHASE) {
    case &#34;sit&#34;:
        env.NODE_PORT = 13003
        env.DUBBO_PORT = 13903
        break
    case &#34;test&#34;:
        env.NODE_PORT = 14003
        env.DUBBO_PORT = 14903
        break
    case &#34;prod&#34;:
        env.NODE_PORT = 15003
        env.DUBBO_PORT = 15903
        break
}</code>
</pre></li>
<li>
<p><code>script</code>中读取参数</p>
<pre class="no-line-numbers language-groovy " title="groovy">
<code>print env.DUBBO_IP</code>
</pre></li>
<li>
<p><code>shell</code>中读取参数</p>
<pre class="line-numbers language-bash " title="bash">
<code>docker build -f kubesphere/Dockerfile \
-t idp-data:$BUILD_TAG  \
--build-arg  PROJECT_VERSION=$PROJECT_VERSION \
--build-arg  NODE_PORT=$NODE_PORT \
--build-arg  DUBBO_PORT=$DUBBO_PORT \
--build-arg PRODUCT_PHASE=$PRODUCT_PHASE .</code>
</pre></li>
<li>
<p><code>yaml</code>文件中读取参数</p>
<pre class="line-numbers language-yaml " title="yaml">
<code>spec:
  ports:
    - name: http
      port: $NODE_PORT
      protocol: TCP
      targetPort: $NODE_PORT
      nodePort: $NODE_PORT
    - name: dubbo
      port: $DUBBO_PORT
      protocol: TCP
      targetPort: $DUBBO_PORT
      nodePort: $DUBBO_PORT
  selector:
    app: lucumt-data-$PRODUCT_PHASE
  sessionAffinity: None
  type: NodePort</code>
</pre></li>
</ul>
<p>运行效果类似下图</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/kubesphere-jenkins-pipeline-run-dialog.png" alt="KubeSphere流水线运行效果" title="KubeSphere流水线运行效果"></p>
<p>详细内容请参见<a href="/post/devops/share-experiences-for-using-kubesphere/">KubeSphere使用心得</a>。</p>
<h4 id="环境扩容">环境扩容</h4>
<p>基于前述方式搭建的4套环境一开始使用较为顺利，但随着项目的推进以及开发人员的增多，同时有多个功能模块需要并行开发与测试，导致原有的4套环境不够用。经过一番摸索后，实现了结合<a href="https://nacos.io/zh-cn/docs/what-is-nacos.html">Nacos</a>在<code>KubeSphere</code>中动态配置多套环境功能，通过修改<code>Nacos</code>中的<code>JSON</code>配置文件可很容易的从4套扩展为16套甚至更多。</p>
<p>结合项目实际情况以及避免后续再次修改<code>KubeSphere</code>流水线，为了实现<strong>灵活的配置多套环境</strong>，制定了如下2个规则：</p>
<ol>
<li>端口信息存放到配置文件中，<code>KubeSphere</code>在构建时去流水线读取相关配置</li>
<li>当需要扩展环境或修改端口时，不需要修改<code>KubeSphere</code>中的流水线，只需要修改对应的端口配置文件即可</li>
</ol>
<p>由于项目中采用<code>Nacos</code>作为配置中心与服务管理平台，故决定采用<code>Nacos</code>作为端口的配置中心，实现流程如下：</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/kubesphere-build-with-nacos-config.png" alt="KubeSphere结合Nacos构建" title="KubeSphere结合Nacos构建"></p>
<p>基于上述流程，在具体实现时面临如下问题：</p>
<ul>
<li>利用<code>Groovy</code>代码获取<code>Nacos</code>中特定的端口<code>JSON</code>配置文件，并能动态解析</li>
<li>利用<code>Groovy</code>代码根据输入输入参数动态的获取<code>Nacos</code>中对应的<code>namespace</code></li>
<li>由于环境的增多，不可能每套环境都准备一个<code>YAML</code>文件，此时需要动态的读取并更新<code>YAML</code>文件</li>
</ul>
<p>由于<code>Jenkins</code>默认不支持<code>JSON</code>、<code>YAML</code>的解析，需要在<code>Jenkins</code>中预先安装<a href="https://www.jenkins.io/doc/pipeline/steps/pipeline-utility-steps/">Pipeline Utility Steps</a>插件，该插件提供了对<code>JSON</code>、<code>YAML</code>、<code>CSV</code>、<code>PROPERTIES</code>等常见文件格式的读取与修改操作。</p>
<ul>
<li>
<p><code>JSON</code>文件设计如下，通过env、server、dubbo等属性记录环境和端口信息，通过project来记录具体的项目名称，由于配置文件中的key都是固定的，后续<code>Groovy</code>解析时会较为方便，在需要扩展环境时只需要更新此<code>JSON</code>文件即可。</p>
<pre class="line-numbers language-json " title="json">
<code>{
    &#34;portConfig&#34;:[
        {
            &#34;project&#34;:&#34;lucumt-system&#34;,
            &#34;ports&#34;:[
                {
                    &#34;env&#34;:&#34;dev-1&#34;,
                    &#34;server&#34;:12001,
                    &#34;dubbo&#34;:12002
                },
                {
                    &#34;env&#34;:&#34;dev-2&#34;,
                    &#34;server&#34;:12201,
                    &#34;dubbo&#34;:12202
                }
            ]
        },
        {
            &#34;project&#34;:&#34;lucumt-idp&#34;,
            &#34;ports&#34;:[
                {
                    &#34;env&#34;:&#34;dev-1&#34;,
                    &#34;server&#34;:13001,
                    &#34;dubbo&#34;:13002
                },
                {
                    &#34;env&#34;:&#34;dev-2&#34;,
                    &#34;server&#34;:13201,
                    &#34;dubbo&#34;:13202
                }
            ]
        }
    ]
}</code>
</pre></li>
<li>
<p><a href="https://nacos.io/zh-cn/docs/open-api.html">Nacos Open Api</a>中可知查询<code>namespace</code>的请求为<code>/nacos/v1/console/namespaces</code>，查询配置文件的请求为<code>/nacos/v1/cs/configs</code>，基于<code>Groovy</code>的读取代码如下：</p>
<pre class="line-numbers language-groovy " title="groovy">
<code>response = sh(script: &#34;curl -X GET &#39;http://xxx.xxx.xxx.xxx:8848/nacos/v1/console/namespaces&#39;&#34;, returnStdout: true)
jsonData = readJSON text: response
namespaces = jsonData.data
for(nm in namespaces){
    if(BUILD_TYPE==nm.namespaceShowName){
        NACOS_NAMESPACE = nm.namespace
    }
}

response = sh(script: &#34;curl -X GET &#39;http://xxx.xxx.xxx.xxx:8848/nacos/v1/cs/configs?dataId=idp-custom-config.json&amp;group=idp-custom-config&amp;tenant=0f894ca6-4231-43dd-b9f3-960c02ad20fa&#39;&#34;, returnStdout: true)
jsonData = readJSON text: response
configs = jsonData.portConfig
for(config in configs){
    project = config.project
    if(project!=PROJECT_NAME){
       continue
    }
    ports = config.ports
    for(port in ports){
        if(port.env!=BUILD_TYPE){
            continue
        }
        env.NODE_PORT = port.server
	}
}</code>
</pre></li>
<li>
<p>动态更新<code>yaml</code>文件</p>
<pre class="line-numbers language-yaml " title="yaml">
<code>yamlFile = &#39;src/main/resources/bootstrap-dev.yml&#39;
yamlData = readYaml file: yamlFile
yamlData.spring.cloud.nacos.discovery.group = BUILD_TYPE
yamlData.spring.cloud.nacos.discovery.namespace = NACOS_NAMESPACE
yamlData.spring.cloud.nacos.config.namespace = NACOS_NAMESPACE
sh &#34;rm $yamlFile&#34;

writeYaml file: yamlFile, data: yamlData</code>
</pre></li>
</ul>
<p>详细内容请参见<a href="/post/devops/using-nacos-and-kubesphere-to-create-multiple-environments/">利用Nacos与KubeSphere创建多套开发与测试环境</a>。</p>
<h4 id="扩展功能">扩展功能</h4>
<ul>
<li>
<p>在项目构建时添加审核功能，对于<code>test</code>和<code>prod</code>环境必须经过相关人的审核才能进行后续构建流程，避免破坏相关版本的稳定性</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/kubesphere-jenkins-pipeline-execute-review.png" alt="项目构建时添加审核功能" title="项目构建时添加审核功能"></p>
</li>
<li>
<p>在<code>KubeSphere</code>的容器组页面可以查看pod节点的CPU和内存消耗，可初步满足对代码潜在性能问题的排查</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/kubesphere-monitor-resouce-consumption.png" alt="监控pod节点资源消耗" title="监控pod节点资源消耗"></p>
</li>
<li>
<p>在项目构建完成时发送邮件通知给相关人</p>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/kubesphere-jenkins-pipeline-mail-notification.png" alt="项目构建完毕发送邮件通知" title="项目构建完毕发送邮件通知"></p>
</li>
</ul>
<h3 id="外部部署">外部部署</h3>
<p>部门内部的软件最终都会销售并交付给相关客户，由于客户网络与公司网络不通以及代码保密等要求，无法在客户现场使用原有的<code>Jenkins</code>流水线进行部署交付。基于此部门采取折中方案：<strong>在公司内部通过<code>KubeSphere</code>进行编译打包，导出<code>docker</code>镜像，拷贝到客户处然后基于<code>docker</code>镜像部署运行</strong>,具体请参见如下链接:</p>
<ul>
<li><a href="/post/devops/git-checkout-by-dynamic-repository-in-jenkins/">在Jenkins中根据配置从不同的仓库中Checkout代码</a></li>
<li><a href="/post/linux/using-script-to-deploy-microservice-application-in-docker/">利用shell脚本实现将微服务程序以docker容器方式自动部署</a></li>
</ul>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/software-deploy-in-customer-environment.png" alt="客户环境部署流程图" title="客户环境部署流程图"></p>
<h3 id="使用协助">使用协助</h3>
<p>在使用过程中确实遇到了不少问题，主要通过如下三条途径解决:</p>
<ul>
<li>阅读<a href="https://kubesphere.io/zh/docs/v3.3">官方文档</a>，根据文档说明操作</li>
<li>若官网文档没有，则去<a href="https://kubesphere.io/forum/">用户论坛</a>查看是否有人遇到类似问题或直接发帖</li>
<li>通过微信群寻求协助</li>
</ul>
<p>根据部门使用经验，90%的问题可通过官方文档或用户论坛获得答案。</p>
<h2 id="使用效果">使用效果</h2>
<p>部分同事习惯于原始的手工操作或基于<code>docker</code>部署，导致在推广过程中受到了一定的阻力，部门内部基于充分沟通和逐步替换的方式引导相关同事来慢慢适应。经过约一年的时间磨合，大家都认可了拥抱云原生和<code>KubeSphere</code>给我们带来的便利，使用过的同事都说很香!</p>
<p>对我司而言，有如下几个方面的提升:</p>
<ul>
<li>研发人员几乎不用耗费时间在软件的部署和监控上，节省约20%时间，产品迭代速度更快</li>
<li>定制化的功能通过脚本实现，彻底杜绝了给客户交付软件时由于人工疏漏导致的偶发问题，在提高软件交付质量的同时也提升了客户我司的认可度</li>
<li>软件开发、测试流程更规范，通过在<code>Jenkins</code>流水线强制添加各种规范检查和审核流程，实现了软件研发的规范统一，代码质量更高，更利于扩展维护，同时也在一定程序上减少了由于人员流失/变更对项目造成的影响</li>
<li>基于<code>KubeSphere</code>的云原生部署结合<code>Nacos</code>可以更快速的分配多套环境，有效的实现了<code>开发</code>、<code>测试</code>、<code>生产</code>环境的隔离，在云仿真相关的业务场景中可基于业务场景更方便的对<code>pod</code>进行监控与调整，前瞻性的业务研发开展更顺利</li>
</ul>
<p><img src="/blog_img/devops/share-kubepshere-using-experience-for-current-company/using-kubesphere-to-deploy.png" alt="日常开发中采用KubeSphere进行集成" title="日常开发中采用KubeSphere进行集成"></p>
<h2 id="规划">规划</h2>
<p>结合公司与部门的实际情况，短期的规划依然是完善基于<code>Jenkins</code>的<code>CI</code>/<code>CD</code>使用来完善打包与部署流程，部门内部在进行全面<code>web</code>化，基于此中长期拥抱云原生。</p>
<ul>
<li>接入企业微信，将构建与运行结果随时通知相关人，构建结果与项目监控更实时</li>
<li>将部门内部基于<code>Eclipse RCP</code>的桌面应用程序通过<code>Jenkins</code>实现标准化与自动化的构建</li>
<li>将底层的<code>Kubernetes</code>从单机升级为集群，支持更多<code>pod</code>的部署，支持公司内部需要大量<code>pod</code>并发运行的云仿真项目</li>
<li>部门内部的<code>web</code>项目全部通过<code>KubeSphere</code>构建部署，完善其使用文档，挖掘<code>KubeSphere</code>在部门业务中新的应用场景(如对设计文档、开发文档、bug修复的定时与强制检查通知等)</li>
</ul>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="/post/devops/share-experiences-for-using-kubesphere/">KubeSphere使用心得</a></li>
<li><a href="/post/devops/setting-ldap-for-kubesphere/">Kubesphere集成LDAP踩坑记录</a></li>
<li><a href="/post/devops/using-nacos-and-kubesphere-to-create-multiple-environments/">利用Nacos与KubeSphere创建多套开发与测试环境</a></li>
<li><a href="/post/devops/git-checkout-by-dynamic-repository-in-jenkins/">在Jenkins中根据配置从不同的仓库中Checkout代码</a></li>
<li><a href="/post/k8s/cpu-resource-not-enough-due-to-invalid-k8s-config/">由于k8s中的错误配置导致无法创建新节点</a></li>
</ul>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubesphere/">kubesphere</a>
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/docker/">docker</a>
          <a href="/tags/jenkins/">jenkins</a>
          <a href="/tags/nacos/">nacos</a>
          <a href="/tags/shell/">shell</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/translate/junit5/junit-5-getting-started/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">[译]JUnit 5 入门 - 编写第一段测试代码</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/ldap/add-ldap-support-for-gitlab/">
            <span class="next-text nav-default">给Gitlab添加LDAP登录认证</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://giscus.app/client.js"
            data-repo="lucumt/ghblog"
            data-repo-id="MDEwOlJlcG9zaXRvcnk0MTQ3MDEzOA=="
            data-category="General"
            data-category-id="DIC_kwDOAnjIus4CRN6c"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="light"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/giscus/giscus">comments powered by giscus.</a></noscript>

      </div>
    </main>
	<footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:cumtlu@126.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/3176419" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://www.linkedin.com/in/%E8%BF%90%E5%BC%BA-%E5%8D%A2-50a08bb5/" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/lucumt" class="iconfont icon-github" title="github"></a>
  <a href="" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2016 - 
    2024<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer><div class="back-to-top" id="back-to-top" title="回到顶部">
      <i class="iconfont icon-up"></i>
    </div>
  </div><script type="text/javascript" src="/lib/jquery/jquery-3.6.4.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script><script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script><script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-75123653-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-75123653-1');
</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-3S3FFW5PH3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3S3FFW5PH3');
</script><script id="baidu_analytics">
	  var _hmt = _hmt || [];
	  (function() {
		if (window.location.hostname === 'localhost') return;
		var hm = document.createElement("script"); hm.async = true;
		hm.src = "https://hm.baidu.com/hm.js?cabc0a71f63da092412d82d1aefe7d1c";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(hm, s);
	  })();
	</script>


	<script id="baidu_push">
	  (function(){
		if (window.location.hostname === 'localhost') return;
		var bp = document.createElement('script'); bp.async = true;
		var curProtocol = window.location.protocol.split(':')[0];
		if (curProtocol === 'https') {
		  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
		}
		else {
		  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
		}
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(bp, s);
	  })();
	</script>


<script>
  let copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
  <path fill-rule="evenodd" 
  d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 
      5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
</svg>`;
  let copiedIcon=`<svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path d="m2.25 12.321 7.27 6.491c.143.127.321.19.499.19.206 0 .41-.084.559-.249l11.23-12.501c.129-.143.192-.321.192-.5 0-.419-.338-.75-.749-.75-.206 0-.411.084-.559.249l-10.731 11.945-6.711-5.994c-.144-.127-.322-.19-.5-.19-.417 0-.75.336-.75.749 0 .206.084.412.25.56" fill-rule="nonzero"/></svg>`;
  function createCopyButton(codeDiv) {
    const div = document.createElement("div");
    div.className = "copy-code";
    div.innerHTML = copyIcon;
    div.addEventListener("click", () =>
      copyCodeToClipboard(div, codeDiv)
    );
    addCopyButtonToDom(div, codeDiv);
  }

  async function copyCodeToClipboard(button, codeDiv) {
    console.log(codeDiv);
    const codeToCopy = codeDiv.querySelector(":scope > code")
      .innerText;
    await navigator.clipboard.writeText(codeToCopy);
    button.blur();
    
	button.innerHTML = copiedIcon;
    setTimeout(() => button.innerHTML = copyIcon, 2000);
  }

  function addCopyButtonToDom(button, codeDiv) {
    codeDiv.insertBefore(button, codeDiv.firstChild);
    const wrapper = document.createElement("div");
    wrapper.className = "highlight-wrapper";
    codeDiv.parentNode.insertBefore(wrapper, codeDiv);
    wrapper.appendChild(codeDiv);
  }

  var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  if(!isMobile){
     document.querySelectorAll("pre[class*=language]").forEach((codeDiv) => createCopyButton(codeDiv));
  }
</script>  




  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-highlight/prism-line-highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

  
  
  <script type="text/javascript">
     document.addEventListener('DOMContentLoaded', initCodeTabs);
	 document.addEventListener('DOMContentLoaded', switchTabCodes);
	 function initCodeTabs(){
	     document.querySelectorAll('.codetabs').forEach(tab =>{
		    let tabHeader = tab.querySelector('.codetabs-header');
			let tabBody = tab.querySelector('.codetabs-body');
		    let codeblocks = tab.querySelectorAll('.codetabs-body > .highlight-wrapper');
			codeblocks.forEach((block,index) =>{
			   let titleContent = block.querySelector('pre').getAttribute('title');
			   let title = document.createElement('div');
			   title.classList.add('tab');
			   if(index == 0){
			   	  title.classList.add('active');
			   }
			   title.setAttribute('data-codetab',index);
			   title.appendChild(document.createTextNode(titleContent));
			   tabHeader.appendChild(title);
			   
			   let div = document.createElement('div');
			   div.classList.add('tab');
			   if(index == 0){
			   	  div.classList.add('active');
			   }
			   div.setAttribute('data-codetab',index);
			   div.appendChild(block);
			   tabBody.appendChild(div);
			});
		 });
	 }
	 function switchTabCodes(){
		 document.querySelectorAll('.codetabs  .codetabs-header > .tab').forEach(tab => {
			 tab.addEventListener('click', function() {
			      if(tab.classList.contains('active')){
					 return;
				  }
				  let tabId = tab.getAttribute('data-codetab');
				  let codetabs = tab.parentNode.parentNode;
				  
				  codetabs.querySelectorAll('.codetabs .tab.active').forEach(e => e.classList.remove('active'));
				  codetabs.querySelectorAll('.codetabs .tab[data-codetab="' + tabId + '"]').forEach(e => e.classList.add('active'));  
			 });
		 });
	 }
  </script>
</body>
</html>
